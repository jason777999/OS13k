<style>body{background:#111;color:#fff;user-select:none;white-space:nowrap;text-align:center}</style>BPM <input type=number style=width:59 id=T value=120> Loop <input type=number style=width:59 id=L value=8> <button onmousedown=A=OS13k.PlayMusic(O(S()))>Play</button> <button onmousedown=S()>Stop</button> <button onmousedown=V()>Save</button> <button onclick=W()>Load</button><a id=H></a><div id=B><script>
/*

todo:
- show play head
- multiple patterns
- pattern sequence
- strict version

*/

OS13k = parent.OS13k;
M = [[],[[]]]; // music

// stop music
onunload = S = e=> A && A.stop();

// set instrument
I = (s, x)=> M[0][x] = OS13k.SeedParameters(s, 1, 1, 0);

// get name of note
Q=e=>e ? e > 0 ? 
    (e >= 1 ? ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][e%12|0] + // note
        '-' + (e/12-1|0) + ' ' : '') +                                         // octave
    (e%1 ? (10 - e*10 % 10|0) + '0%' : '') :                                   // volume
    e < -1 ? ' End' : 'Stop' : '';                                             // special notes

// set note
N = (e, x, y)=>
{
    v = e.keyCode == 8 ? v = 0 : // delete = clear
    e.keyCode == 32 ? v = -1 : // space = stop
    e.keyCode == 13 ? v = -2 : // enter = end
    e.keyCode == 38 || e.keyCode == 40 ? // up/down = volume
    (
        n = M[1][0][x][y] > 0 ? M[1][0][x][y] : 0,
        v = (n|0) + ((n*10%10 + 10 + (e.keyCode - 39)) / 10)%1
    ) :
    OS13k.PianoKey(e) >= 0 ? v = 12 + OS13k.PianoKey(e) : 
    -3; // no valid input

    // if input was valid
    if (v > -3)
    {
        // set note value and input text
        e.target.value = Q(M[1][0][x][y] = v);

        // set zzfx parameters
        p = [...M[0][x]];
        p[2] = OS13k.Note(v - 12|0, p[2]);
        p[0] *= 1 - v%1;

        // stop old sound and play new one if valid
        Z && Z.stop();
        v > 0 && (Z = zzfx(...p));
    }

    // only allow to continue if tab
    return e.keyCode == 9;
}

// build music
O = e=>
{
    // create music format, with padding at end
    m = [M[0], [[],[0,0,0,0,0,0,0,0]], [], T.value = OS13k.Clamp(T.value, 1e3, 60)];

    // set sequence loop
    m[2].length = L.value = OS13k.Clamp(L.value, 64, 1);

    // fill sequence with pattern 0 and set x
    m[2].fill(x = 0);

    // get end of patterns, add empty sequence at end as padding
    for(m[2][L.value] = 1; x < 4; ++x)
    {
        // clone pattern
        m[1][0][x] = [...M[1][0][x]];

        // chop off at end marker (-2) or if no more notes
        for(n = y = 2; y < 130; ++y)
            n = m[1][0][x][y] == -2 ? y : m[1][0][x][y] ? y + 1 : n;
        m[1][0][x].length = Math.max(n, M[1][0].reduce((a,c)=>Math.max(a, c.length), 0));
    }

    return m;
}

//////////////////////////////////////////////////////////////
// init

// rebuild pattern display
R = e=>
{
    o = '<p>';
    for(x = -2; ++x < 9; o += '<br>')
    for(y = 0; y < 130; ++y)
    {
        o += 
            // beat index display
            x == -1 ? `<span style=display:inline-block;width:${y<2?140:80}>${y>1?y-1:''}</span>` :

            // note
            y > 1 ? `<input style=width:80;${(y+2)%4? '' : 'background:#ccf'} onkeydown='return N(event,${x},${y})'value=${Q(M[1][0][x][y])}>` :

            // empty
            y ? '' :

            // instrument, pan, and init
            (
                // init channel
                M[1][0][x] || (M[1][0][x] = [x, 0]),

                // set instrument
                I(m = M[0][x]?'zzfx(...['+M[0][x]+'])' : '', x),

                // instrument and pan setting
                `<span style=display:inline-block;width:280>üå± <input style=width:99 oninput=I(event.target.value,${x}) placeholder='ZzFX or Seed'value=${m}> üéß <input style=width:99 oninput=M[1][0][${x}][1]=event.target.value/50-1 type=range value=${(M[1][0][x][1]||0)*50+50}></span>`
            );
    }
    B.innerHTML = o;
}

// build the display, init last music and sound played
R(A = Z = 0);

//////////////////////////////////////////////////////////////
// save / load

// convert zzfxm code to string
D = e=> Array.isArray(e) ? '[' + e.map(e=>D(e)).join(',') + ']': e;

// save
V = e=> H.click(H.href = URL.createObjectURL(new Blob([D(O())])), H.download = 'ZzFXM');

// load
W = e=>
{
    try
    {
        // load song data
        M = OS13k.StringToMusic(d = prompt `ZzFXM Data`, 1);

        // set end at max channel length
        M[1][0][0][M[1][0].reduce((a,c)=>Math.max(a, c.length), 0)] = -2;

        // rebuild and set bpm
        R(T.value = M[3]);
    }
    catch (e) { alert`‚ö†Ô∏è Error!`;console.log(e);} // load failed
}

</script>