<style>body{background:#111;color:#fff;user-select:none}</style><center>
BPM <input type=number style=width:59 id=T value=120>
Loop <input type=number style=width:59 id=L value=8>
<button onmousedown=P()>Play</button> <button onmousedown=S()>Stop</button> <button onmousedown=V()>Save</button> <button onclick=W()>Load</button>
<hr><a id=H></a><div id=B>
<script>
/*

up down to set octave
left right to set volume
show note and volume

color changed notes
- color by frequency and volume
show play head

save/load


*/

OS13k = parent.OS13k;
M = [[],[[]], A = Z = 0]; // music, last sound played

// build music
O = e=>
{
    // create music format
    m = [M[0], [[]], [], T.value = OS13k.Clamp(T.value, 1e3, 60)];

    // set sequence loop
    m[2].length = L.value = OS13k.Clamp(L.value, 64, 1);
    m[2].fill(0);

    // get end of patterns
    for(x=0; x<4; ++x)
    {
        // clone the pattern
        m[1][0][x] = [...M[1][0][x]];

        // look for end
        for(y=2; y < 130; )
            if (m[1][0][x][y++] == -2)
            {
                m[1][0][x].length = y;
                break;
            }
    }

    return m;
}

// play music
P = e=>A = OS13k.PlayMusic(O(S()));

// stop music
onunload = onblur = S = e=> A && A.stop();

// set instrument
I = (s, x)=> M[0][x] = OS13k.SeedParameters(s, 1, 1, 0);

// get name of note
Q=e=>e ? e > 0 ? ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'][e%12] + ' - ' + (e/12-1|0) : e < -1 ? ' End' : 'Stop' : '';

// set note
N = (e, x, y)=>
{

    v = -3;
    if (e.keyCode == 8)
        v = 0;
    else if (e.keyCode == 32)
        v = -1;
    else if (e.keyCode == 13)
        v = -2;
    else if (OS13k.PianoKey(e) >= 0 )
        v = 12 + OS13k.PianoKey(e);

    if (v > -3)
        e.target.value = Q(v);

    M[1][0][x][y] = v;

    p = [...M[0][x]];
    p[2] = OS13k.Note(v - 12, p[2]);

    Z && Z.stop();
    if (v > 0)
        Z = zzfx(...p);

    return false;
}

//////////////////////////////////////////////////////////////
// save / load

// convert zzfxm code to string
D = e=> Array.isArray(e) ? '[' + e.map(e=>D(e)).join(',') + ']': e;

// save
V = e=> H.click(H.href = URL.createObjectURL(new Blob([D(O())], {type:'text/plain'})), H.download = 'zzfxm');

// load
W = e=>
{
    try {
        m = OS13k.SafeEval(d = prompt `ZzFXM Data`);
        parent.zzfxM(...m);   // try to generate song

        // copy the song data
        M = m;
        T.value = M[3];

        // set ends
        //l = 0;
        //M[1][0].map(channel=>l = Math.max(l,channel.length));
        //M[1][0][0][l] = -2;

        // rebuild
        R();

    }
    catch (e) { alert`⚠️ Error!`;console.log(e);}     // load failed
}

//////////////////////////////////////////////////////////////
// init

R = e=>
{
    o = '<table>';
    for(y=0; y<130; ++y)
    {
        o += '<tr>';
        for(x=0; x<5; ++x)
        {
            o += '<td style=white-space:nowrap>';
            if (x>3)
                o += y ? y-1 ? y-1 : '🎧' : '🌱';
            else if (y==0)
            {
                m = M[1][0][x] || (M[1][0][x] = [x, 0]);

                o += `<input style=width:100% onchange=I(event.target.value,${x}) placeholder='ZzFX or Seed' value=${m=M[0][x]?'zzfx(...['+M[0][x]+'])' : ''}>`;
                I(m, x);
            }
            else if (y==1)
                o += `<input style=width:100% onchange=M[1][0][${x}][1]=event.target.value/50-1 type=range title=Pan value=${M[1][0][x][y]*50+50 || 50}>`;
            else
                o += `<input style=width:100%;${(y+2)%4? '' : 'background:#fdd'} onkeydown='return N(event,${x},${y})' value=${Q(M[1][0][x][y])}>`;
            o += '</td>';
        }
        o += '</tr>';
    }

    B.innerHTML = o;
}

R();

</script>