<html>
<head>
<title>OS13k - A tiny pseudo operating system for JS13k</title>
<meta charset=utf-8>
</head>
<body>
<style>
*
{
    font-family:arial;
}
body
{
    overflow:hidden;
    background:linear-gradient(#223,#322);
    background-attachment:fixed;
}
*:active
{
    cursor:grabbing;
}
.title
{
    font-size:300;
    font-family:impact;
    color:#0002;
    height:100%;
    user-select:none;
    display:flex;
    align-items:center;
    justify-content:center;
}
</style>
<template id=templateIcon>
<style>
:host
{
    position:absolute;
    display:flex;
    align-items:center;
    flex-direction:column;
    user-select:none;
    cursor:grab;
    pointer-events:auto;
}
.icon
{
    width:64;
    height:64;
    font-size:42;
    background:linear-gradient(#fff,#999);
    border-radius:9px;
    box-shadow:4px 4px 5px #000;
    overflow:hidden;
    white-space:nowrap;
    pointer-events:none;
    display:flex;
    align-items:center;
    justify-content:center;
}
.name
{
    position:absolute;
    top:70;
    text-align:center;
    font-size:18;
    color:#FFF;
    text-shadow:1px 1px 5px #000;
}
</style>
</template>
<template id=templateWindow>
<style>
:host
{
    position:absolute;
    user-select:none;
    background:#000;
    display:flex;
    flex-direction:column;
    border:2px solid #000;
    box-shadow:9px 9px 9px #000;
    overflow:hidden;
}
.frame
{
    position:relative;
    width:100%;
    height:100%;
    border:none;
    overflow:hidden;
    background:#FFF;
}
.folder
{
    background:#222;
}
.titleBar
{
    font-size:32;
    cursor:grab;
}
.resize
{
    position:absolute;
    right:23;
    font-size:23;
}
.resize:hover
{
    background:#fff;
}
.close
{
    position:absolute;
    right:0;
    font-size:32;
}
.close:hover
{
    background:#f00;
}
</style>
<span id=resize class=resize>üóñ</span>
<span id=close class=close>√ó</span>
</template>
<span class=title>OS13k</span>
<span id=os13kDesktop></span>
<script>

// ==ClosureCompiler==
// @compilation_level ADVANCED_OPTIMIZATIONS
// @language_out ECMASCRIPT_2019
// @js_externs OS13k, OS13kIcon, OS13kWindow, zzfx, zzfxV
// @js_externs _OS13k.Medal, _OS13k.Medal, _OS13k.GetKeyDirection
// @js_externs _OS13k.PlaySamples, _OS13k.CreateShader, _OS13k.RenderShader
// @js_externs _OS13k.Random, _OS13k.randomSeed, _OS13k.CreateDweet
// @output_file_name OS13k.min.js
// ==/ClosureCompiler==

"use strict";

/////////////////////////////////////////////////////////////////////////////
// OS13k desktop

const desktopLayout = 
[
{name:'Help', icon:'‚ùì', src:'help.html?6', open:1, width:400, height:380},
{name:'System', icon:'‚öôÔ∏è', folder:
[
    {name:'Test', icon:'üòÑ', src:'system/test.html?3', hideWhenClosed:1},
]},
{name:'Games', icon:'üéÆ', folder:
[
    {name:'Lava Rush', icon:'üåã', author:'Jeremy Burns', src:'games/lavaRush.html?2'},
    {name:"Sn1ke", icon:'üëÄ', src:'games/sn1ke.html', author:'Xem', width:400, height:330, hideWhenClosed:1},
    {name:"Tetris", icon:'üÜÉ', author:'Veubeke', src:'games/tetris.html', width:220, height:430},
    {name:"Queen's Gambit", icon:'<span style=color:#f0f>‚ôõ</span>', src:'games/queensGambit.html?1', width:1290, height:720},
    {name:'Free Cell', icon:'‚ô†Ô∏è', src:'games/freeCell.html', width:800, height:1e3, hideWhenClosed:1},
    {name:'Digit Dilemma', icon:'<span style=font-family:monospace>‚òª</span>', src:'games/digitDilemma.html'},
    {name:'Hue Jumper', icon:'üå≤', src:'games/hueJumper.html', width:1290, height:720},
]},
{name:'Utilities', icon:'üîß', folder:
[
    {name:'Photo Booth', icon:'üì∏', src:'utilities/photoBooth.html', width:1380, height:600},
    {name:'Unicode Toys', icon:'ùñÄ', author:'Xem', src:'utilities/unicodeToys.html', width:500, height:800},
    {name:'Mini Shadertoy', icon:'ùì¢', src:'utilities/miniShadertoy.html', width:340, height:400},
]},
{name:'Toys', icon:'ü§ñ', folder:
[
    {name:'ZzFX Sounds', icon:'ùêôùêô', src:'toys/zzfxSoundBoard.html'},
    {name:'Yin Yangs', icon:'‚òØÔ∏è', src:'toys/infiniteYinYangs.html?1'},
]},
{name:'Dweets', icon:'<b>III</b>', folder:
[
    {name:'Black Hole', icon:'üåå', src:'dweets/blackHole.html'},
    {name:'Mandelbrot Nebula', icon:'üåü', src:'dweets/mandelbrotNebula.html'},
    {name:'Bogus Roads', icon:'üõ£Ô∏è', src:'dweets/bogusRoads.html'},
    {name:'Automatic Breakout', icon:'‚óè', src:'dweets/breakout.html'},
    {name:'Underwater Cavern', icon:'üåä', author:'Pavel', src:'dweets/underwaterCavern.html'},
    {name:'City Traffic', icon:'üöå', author:'Tomxor', src:'dweets/cityTraffic.html'},
    {name:'Train Set', icon:'üöÇ', author:'jylikangas', src:'dweets/trainSet.html'},
]},
{name:'Favorites', folder:[]},
];

/////////////////////////////////////////////////////////////////////////////
// OS13k System

class _OS13k
{
    constructor()
    {
        // init web audio
        this.audioContext = new (window.AudioContext || webkitAudioContext);
        this.audioContext._createBufferSource = this.audioContext.createBufferSource;
        this.audioContext.createBufferSource =
        (s = this.audioContext._createBufferSource())=>
        (
            s.start = s.start || (t => this.audioContext.noteOn (t)),
            s.stop  = s.stop  || (t => this.audioContext.noteOff(t)),
            s
        );
        
        // startup os13k
        this.InitDesktop();
        this.randomSeed = Date.now();
        setInterval(this.Update, 99);
    }
    
    InitDesktop()
    {
        // add icons to desktop
        let X = iconGridSizeX/4 - iconGridSizeX;
        const AddIcon=p=>
        {
            p.x = X+=iconGridSizeX;
            p.y = iconGridSizeX/4; 
            const icon = new OS13kIcon(p); 
            os13kDesktop.appendChild(icon); 
            if (p.open)
                icon.Open();
            return icon;
        }
        for (const i of desktopLayout)
            AddIcon(i);
    }
    
    Update()
    {
        // listen for change in active element
        // this happens when clicking on an iframe
        const activeElement = document.activeElement;
        if (this.lastActiveElement != activeElement)
        {
            if (activeElement.localName == 'os13k-window')
                activeElement.focus();
            this.lastActiveElement = activeElement;
        }
    }
    
    Medal(gameName, medalName, difficulty, icon)
    {
        // show popup and unlock medal
    }
    
    GetKeyDirection(keyCode)
    {
        // get direction from wasd or arrow keys
        let x = 0;
        let y = 0;
        if (keyCode == 87 || keyCode == 38) // up
            y += 1;
        if (keyCode == 83 || keyCode == 40) // down
            y -= 1;
        if (keyCode == 68 || keyCode == 39) // right
            x += 1;
        if (keyCode == 65 || keyCode == 38) // left
            x -= 1;
        return {x, y}
    }
    
    PlaySamples(samples)
    {
        // play raw audio sample data
        const buffer = this.audioContext.createBuffer(1, samples.length, 44100);
        const source = this.audioContext.createBufferSource();
        buffer.getChannelData(0).set(samples);
        source.buffer = buffer;
        source.connect(this.audioContext.destination);
        source.start();
        return source;
    }
    
    CreateShader(canvas, code)
    {
        const x = canvas.getContext('webgl');

        // create simple pass through vertex shader
        const vertexShader = x.createShader(x.VERTEX_SHADER);
        x.shaderSource(vertexShader,"attribute vec4 p;void main(){gl_Position=p;}");
        x.compileShader(vertexShader);
        
        // create vertex buffer that is a giant triangle to cover the viewport
        const vertexBuffer = x.ARRAY_BUFFER;
        x.bindBuffer(vertexBuffer,x.createBuffer());
        x.bufferData(vertexBuffer,new Int8Array([-3,1,1,-3,1,1]),x.STATIC_DRAW);
        x.enableVertexAttribArray(0);
        x.vertexAttribPointer(0,2,x.BYTE,0,0,0); // 2D vertex
        
        // create shadertoy compatible pixel shader
        const pixelShader = x.createShader(x.FRAGMENT_SHADER)
        const shaderProgramCode = 
            'precision mediump float;'
            + 'uniform vec3 iResolution;'
            + 'uniform float iTime;\n'
            + code
            + '\nvoid main()'
            + '{mainImage(gl_FragColor,gl_FragCoord.xy);gl_FragColor.a=1.;}'
        x.shaderSource(pixelShader, shaderProgramCode)
        x.compileShader(pixelShader);

        // check for errors
        if (!x.getShaderParameter(pixelShader, x.COMPILE_STATUS))
        {
            console.log(x.getShaderInfoLog(pixelShader));
            return;
        }

        // create program
        const shaderProgram = x.createProgram();
        x.attachShader(shaderProgram, vertexShader);
        x.attachShader(shaderProgram, pixelShader);
        x.linkProgram(shaderProgram);
        x.useProgram(shaderProgram);
        return shaderProgram;
    }
    
    RenderShader(canvas, shaderProgram, time=0)
    {
        const x = canvas.getContext('webgl');
        
        // set uniforms
        x.uniform3f(x.getUniformLocation(shaderProgram,"iResolution"),
            canvas.width, canvas.height, 0);
        x.uniform1f(x.getUniformLocation(shaderProgram,"iTime"), time);
        
        // render shader
        x.viewport(0, 0, canvas.width, canvas.height);
        return x.drawArrays(x.TRIANGLE_FAN, 0, 3);
    }
    
    CreateDweet(document, code)
    {
        // set up document
        document.body.innerHTML = '<canvas id=c width=1920 height=1080 style=background:#FFF>';
        document.body.style = 'background:#111;margin:0;display:flex;align-items:center;justify-content:center;overflow:hidden';
        
        // create dweet
        document.defaultView.eval('function u(t){' + code + '}x=c.getContext`2d`;frame=0;S=Math.sin;C=Math.cos;T=Math.tan;R=(r,g,b,a=1)=>`rgba(${0|r},${0|g},${0|b},${a})`;loop=()=>requestAnimationFrame(loop,document.hasFocus()&&u((60*(frame++/60)-frame-1|0?frame-1:frame)/60),c.style.width=1920/1080>innerWidth/innerHeight?innerWidth:innerHeight*1920/1080);loop()');
    }
    
    Random(max=1, min=0)
    {
        // Mersenne Twister
        this.randomSeed ^= this.randomSeed << 13;
        this.randomSeed ^= this.randomSeed >> 17;
        this.randomSeed ^= this.randomSeed << 5;
        return max + (min-max) * (Math.abs(this.randomSeed) % 1e9 / 1e9);
    }
    
}; // _OS13k

/////////////////////////////////////////////////////////////////////////////
// OS13kIcon

const iconGridSizeX = 99;
const iconGridSizeY = 130;
let windowOpenOffset = 99;
let topIconZ = 0;

class OS13kIcon extends HTMLElement
{
	constructor({x, y, name, icon, src, width=720, height=450, author, hideWhenClosed, allowMultiple, folder})
    {
		super();
        
        // set defaults
        src = src || '';
        name = name || src.split('.')[0];
        icon = icon || ( folder ? 'üìÅ' : name[0]? name[0].toUpperCase() : '' );
        
        // set icon data
		this.shadow = this.attachShadow({mode: 'open'});
        this.name = name;
        this.icon = icon;
        this.src = src;
        this.windowWidth = width;
        this.windowHeight = height;
        this.style.left = x;
        this.style.top = y;
        this.author = author;
        this.hideWhenClosed = hideWhenClosed || folder;
        this.allowMultiple = allowMultiple;
        this.folder = folder;
        
        // create shadow root
        this.shadowRoot.innerHTML = templateIcon.innerHTML
            +`<span class=icon>${ icon }</span>`
            +`<span class=name>${ name }</span>`;
    }
    
    Open()
    {
        if (this.os13kWindow && !this.allowMultiple)
        {
            // reopen the old window
            this.os13kWindow.style.display = '';
        }
        else
        {
            // stager open positions
            windowOpenOffset += 50;
            if (windowOpenOffset > 300)
                windowOpenOffset = 50;

            // open the window
            this.os13kWindow = new OS13kWindow({x:windowOpenOffset, y:windowOpenOffset, icon:this});
            os13kDesktop.appendChild(this.os13kWindow);
        }
        
        // set focus to window
        this.os13kWindow.focus();
    }
    
    MouseDown()
    {
        // focus on icon's window if it exists
        if (this.parentElement && this.parentElement.os13kWindow)
            this.parentElement.os13kWindow.focus();
        
        // create move icon that is temporary copy
        const rect = this.getBoundingClientRect();
        const moveIcon = new OS13kIcon({x:rect.left, y:rect.top, name:this.name, icon:this.icon});
        moveIcon.realIcon = this;
        moveIcon.style.opacity = .5;
        moveIcon.style.zIndex = ++activeWindowZ;
        moveIcon.style.pointerEvents = 'none';
        os13kDesktop.appendChild(moveIcon);
        selected = moveIcon;
    }
    
    MouseUp(e)
    {
        // get rect before it is removed
        const rect = this.getBoundingClientRect();
        
        // get rid of this temporary move icon
        os13kDesktop.removeChild(this);
        
        // get element under mouse
        const element = document.elementFromPoint(e.x, e.y);
        if (!element)
            return;
            
        let target = os13kDesktop;
        let x = rect.left;
        let y = rect.top;
        if (element.localName == 'os13k-window')
        {
            // only allow dropping into folders
            if (!element.os13kIcon.folder)
                return;
               
            // prevent dropping on title bar
            const shadowElement = element.shadowRoot.elementFromPoint(e.x, e.y);
            if (shadowElement && shadowElement.id)
                return;
                
            // prevent recursive folders
            const DetectSelfReference=icon=>
            {
                if (icon.os13kWindow == element)
                    return 1;
                
                if (icon.os13kWindow && icon.os13kWindow.folder)
                    for( const c of icon.os13kWindow.folder.children)
                        if (DetectSelfReference(c))
                            return 1;
            }
            if (DetectSelfReference(this.realIcon))
            {
                alert('Self referential folders detected!');
                return;
            }
            
            // adjust position to local space of parent
            const rect = element.folder.getBoundingClientRect();
            x -= rect.left;
            y -= rect.top;
            
            // put icon in folder
            target = element;
        }

        // move icon if it is a different folder
        const targetFolder = target.folder ? target.folder : target;
        if (targetFolder != this.realIcon.parentElement)
        {
            targetFolder.appendChild(this.realIcon);

            // deactivate window if dropped in desktop
            if (activeWindow && targetFolder == os13kDesktop)
                activeWindow.SetActive(0);
        }
        target.focus();
            
        // set icon position
        this.realIcon.style.left = x;
        this.realIcon.style.top = y;
        this.realIcon.style.zIndex = ++topIconZ;
    }
} // OS13kIcon

customElements.define('os13k-icon', OS13kIcon);

/////////////////////////////////////////////////////////////////////////////
// OS13kWindow

let activeWindow;
let activeWindowZ = 1e7;

class OS13kWindow extends HTMLElement
{
	constructor({x, y, icon})
    {
		super();
        	
        // set window data
        this.maximized = 0;
        this.os13kIcon = icon;
        this.style.left = x;
        this.style.top = y;
        this.style.width = icon.windowWidth;
        this.style.height = icon.windowHeight;
        
        // create shadow root
		this.shadow = this.attachShadow({mode: 'open'});
        this.shadowRoot.innerHTML = templateWindow.innerHTML;
        
        // create title bar
        const titleBar = document.createElement('span');
        titleBar.className = 'titleBar';
        titleBar.id = 'titleBar';
        titleBar.innerHTML = '&nbsp;' 
            + icon.icon + ' ' 
            + icon.name + ' ' 
            + (icon.author? ' (' +icon.author +')': '');
        this.shadowRoot.appendChild(titleBar);
        this.titleBar = titleBar;
        
        const titleBarGap = document.createElement('span');
        titleBarGap.style.height = 2;
        this.shadowRoot.appendChild(titleBarGap);
        
        if (icon.folder)
        {
            // create folder frame
            const folder = document.createElement('div');
            folder.className = 'folder frame';
            folder.os13kWindow = this;
            this.folder = folder;
            this.shadow.appendChild(folder);
            this.focus();

            // add icons to folder
            let X = iconGridSizeX/4-iconGridSizeX;
            const AddIcon=p=>
            {
                p.x=X+=iconGridSizeX; p.y=iconGridSizeX/4; 
                folder.appendChild(new OS13kIcon(p));
            }
            for (const i of icon.folder)
                AddIcon(i);
        }
        else if (icon.src)
        {
            // create iframe
            const iframe = document.createElement('iframe');
            iframe.className = 'frame';
            iframe.sandbox.add('allow-scripts');
            iframe.sandbox.add('allow-same-origin');
            iframe.sandbox.add('allow-popups');
            iframe.sandbox.add('allow-modals');
            iframe.sandbox.add('allow-pointer-lock');
            iframe.onload=e=>
            {
                // init iframe
                const iframe_content = e.target.contentWindow;
                this.iframe_content = iframe_content;
                this.focus();
                
                // try to pass os13k to iframe
                try
                {
                    iframe_content.OS13k = OS13k;
                    iframe_content.zzfx = zzfx;
                }
                catch (e)
                {
                    // This may be due to file:// links being treated as
                    // different origin in some browsers for security reasons.
                    throw e;
                }
                
                // init os13k in iframe
                if (iframe_content.OS13kStart)
                    iframe_content.OS13kStart();
            };
            iframe.src = icon.src;
            this.shadow.appendChild(iframe);
        }
    }
    
    focus()
    {
        super.focus();
        
        // decative old window
        if (activeWindow && activeWindow != this)
            activeWindow.SetActive(0);
        
        this.SetActive();
    }
    
    SetActive(active=1)
    {
        // change title color when active
        this.titleBar.style.background = active ? '#aac' : '#777';
        
        if (active)
        {
            // move to top when active
            this.style.zIndex = ++activeWindowZ;
            activeWindow = this;
            
            // set focus to iframe
            if (this.iframe_content)
                this.iframe_content.focus();
        }
        else
            activeWindow = 0;
    }
    
    Close()
    {
        if (this.os13kIcon.hideWhenClosed)
        {
            // hide window so it can be reopened
            this.style.display = 'none';
            if (this.maximized)
                this.Resize();
        }
        else
        {
            // destroy window
            this.os13kIcon.os13kWindow = 0;
            this.remove();
        }
    }
    
    MouseDown(id)
    {
        // check for title bar buttons
        if (id == 'close')
            this.Close();
        else if (id == 'resize')
            this.Resize();
            
        // give focus to window
        this.focus();
        
        // allow dragging from the title bar
        if (id == 'titleBar')
            selected = this;
    }
    
    Resize()
    {
        if (this.maximized = !this.maximized)
        {
            // save old values
            this.oldLeft = this.style.left;
            this.oldTop = this.style.top;
            this.oldWidth = this.style.width;
            this.oldHeight = this.style.height;
            
            // set to max size
            this.style.left = 5;
            this.style.top = 5;
            this.style.width = innerWidth-18;
            this.style.height = innerHeight-18;
        }
        else
        {
            // reset to old values
            this.style.left = this.oldLeft;
            this.style.top = this.oldTop;
            this.style.width = this.oldWidth;
            this.style.height = this.oldHeight;
        }
        
        // set resize icon on titlebar
        this.shadowRoot.getElementById('resize').innerHTML = 
            this.maximized ? 'üóó' : 'üóñ';
    }
} // OS13kWindow

customElements.define('os13k-window', OS13kWindow);

/////////////////////////////////////////////////////////////////////////////
// Input

let selected;
let seletOffsetX;
let seletOffsetY;

onmousedown=e=>
{
    if (selected)
    {
        // prevent getting stuck
        onmouseup(e);
        return;
    }
    
    // prevent pointer events while dragging
    os13kDesktop.style.pointerEvents = 'none';
    document.body.style.cursor = 'grabbing';
    
    // get os13k target
    const originalTarget = e.originalTarget || e.path[0];
    const target = originalTarget.parentNode.host || originalTarget;
    
    // set selected offset
    const rect = target.getBoundingClientRect();
    seletOffsetX = e.x - rect.left;
    seletOffsetY = e.y - rect.top;
    
    // handle mouse down event
    if (target.localName == 'os13k-icon' || target.localName == 'os13k-window')
        target.MouseDown(originalTarget.id);
    else
    {
        // deactivate window if not clicked on
        if (activeWindow)
            activeWindow.SetActive(0);
    }
    
    e.preventDefault();
}

onmouseup=e=>
{
    // allow pointer events and reset cursor
    os13kDesktop.style.pointerEvents = '';
    document.body.style.cursor = '';
    
    // release selected
    if (selected && selected.MouseUp)
        selected.MouseUp(e);
    selected = 0;
    
    e.preventDefault();
}

onmousemove=e=>
{
    // update selected position
    if (selected)
    {
        selected.style.left = e.x - seletOffsetX;
        selected.style.top = e.y - seletOffsetY;
    }
    
    e.preventDefault();
}

ondblclick=e=>
{
    // get os13k target
    const originalTarget = e.originalTarget || e.path[0];
    const target = originalTarget.parentNode.host || originalTarget;
    if (target.localName == 'os13k-icon')
        target.Open();
    
    e.preventDefault();
}

/////////////////////////////////////////////////////////////////////////////
// ZzFXMicro - Zuper Zmall Zound Zynth 

let zzfxV = .3; // volume
const zzfx =    // play sound
(I=1,J=.05,g=220,f=0,h=0,m=.1,n=0,K=1,r=0,z=0,t=0,A=0,u=0,B=0,v=0,L=0,e=0,d=2*Math.PI,b=44100,w=p=>2*p*Math.random()-p,C=p=>0<p?1:-1,M=r*=500*d/b**2,D=g*=(1+w(J))*d/b,N=C(v)*d/4,q=[],E=0,F=0,c=0,k=1,G=0,H=0,a=0,O,l)=>{f=99+f*b|0;h=h*b|0;m=m*b|0;e=e*b|0;z*=500*d/b**3;l=f+h+m+e;v*=d/b;t*=d/b;A*=b;for(u*=b;c<l;q[c++]=a)++H>100*L&&(H=0,a=E*g*Math.sin(F*v-N),a=n?1<n?2<n?3<n?Math.sin((a%d)**3):Math.max(Math.min(Math.tan(a),1),-1):1-(2*a/d%2+2)%2:1-4*Math.abs(Math.round(a/d)-a/d):Math.sin(a),a=C(a)*Math.abs(a)**K,a*=I*zzfxV*(c<f?c/f:c<f+h?1:c<l-e?1-(c-f-h)/m:0),a=e?a/2+(e>c?0:(c<l-e?1:(c-l)/e)*q[c-e]/2):a),E+=1+w(B),F+=1+w(B),g+=r+=z,k&&++k>A&&(D+=t,g+=t,k=0),u&&++G>u&&(g=D,r=M,G=1,k=k||1);return OS13k.PlaySamples(q)}

/////////////////////////////////////////////////////////////////////////////
// OS13k startup!

const OS13k = new _OS13k;

</script>
</body>
</html>