<style>body{background:#111;color:#fff;user-select:none;text-align:center}</style><span id=B></span>Seed
<input id=S style=width:79 oninput=E(T=3) onfocus=E(T=3)>
Octave <input type=number id=O style=width:40 value=0 min=-1 max=1 onfocus=this.blur()>&nbsp;
Key <input type=number id=Y style=width:40 value=0 min=0 max=12 onfocus=this.blur()><br>
Gain <input type=range style=width:60 onchange=R() id=V>
Noise <input type=range style=width:60 onchange=R() value=0 id=N>
Shape <input type=range style=width:60 onchange=R() id=H>
Crush <input type=range style=width:60 onchange=R() value=0 id=C><hr><div><script>

//////////////////////////////////////////////////////////////
// sound

// build cached samples
R = e=>
{
    // cache samples
    D = [];
    
    for(i=6;--i;) 
        r = parent.OS13k.Note(i*12-21), // root frequency C
        D[i] =                          // for each octave
        T-3 ? [                         // instruments
            [1, 2, 4, 8],               // organ
            [3, 5, 7, 9],               // oboe
            [1]                         // sin wave
        ][ T ].map(e=>                  // get instrument
                parent.zzfxG(...[       // generate zzfx samples
                V.value/99/             // get volume
                    (1+Math.log2(e)),   // scale volume
                0,                      // no randomness
                e*r,,                   // frequency
                2,                      // sustain
                .5,,                    // release
                (H.value/50)**4,,,,,,   // shape curve
                N.value/99,,            // noise
                C.value/500,,           // bit crush  
                .7,                     // sustain volume
                .1                      // decay
            ])) :
        [OS13k.SeedSamples(S.value, 1, V.value / 99, 0, r)]; // get seed samples
}

// play note
P = e=> e < 0 || !A[e] && // skip if invalid note or already playing
(
    // change button color
    b = eval('B' + e),           // get the button
    b.style.transition = '',     // unset transition
    b.B = b.style.background,    // save old background color
    b.style.background = '#f00', // set background to red
    b.innerText,                 // force reset transition

    // play cached sound
    A[e] = D[2 + O.value*1 + e/12|0].           // get octave
        map(d=>((s = OS13k.PlaySamples(d, 1)).  // play samples
        detune.value =                          // set frequency
            e%12*100 +                          // get note offset
            Y.value*100                         // apply key control
            -1200, s))                          // start 1 octave below
);

// cancel note
X = e=> A[e] && 
(
    b = eval('B' + e),          // get button
    b.style.transition = '.5s', // set transition
    b.style.background = b.B,   // reset old background color
    Z.push(...A[e]),            // add to canceled sounds list
    A[e] = 0                    // remove from playing sounds list
);

// stop all sounds if focus lost or unloaded
onunload = onblur = e=>
(
    A.map((e,i)=>X(i)), // cancel all notes
    Z.map(e=>e.stop()), // stop all canceled notes
    Z = []              // clear canceled notes
);

//////////////////////////////////////////////////////////////
// init

// rebuild instrument buttons
E = e=> R(                    // rebild cache
        B.innerHTML = '',     // clear HTML

        // create buttons
        ['Organ', 'Oboe', 'Wave'].map((i,j)=>               // instruments
            B.innerHTML +=                                  // add to HTML
            `<button style='border:5px solid${              // button and border
                T-j ? "#111" : "#f00" }' onmousedown=E(T=${ // border color
                j })>${                                     // select on mouse down
                i }</button> `),                            // button text
                
        // set seed boder
        S.style.border = `5px solid${                     // set border
            (C.disabled = H.disabled = N.disabled = T==3) // disable if seed
            ? "#f00" : "#111" }`);                        // set color

// create piano keys
for( T = i = 0;  // init selected sound & iterator
        i < 36;) // 36 keys
    document.body.innerHTML +=                                 // add to html
    `<div id=B${ z = 24 - (i/12|0)*12 + i%12                   // reorder keys
    } onmouseover=event.buttons&&P(${ z                        // mouse over
    }) onmousedown=P(${ z                                      // mouse down
    }) onmouseup=X(${ z                                        // mouse up
    }) onmouseout=X(${ z                                       // mouse out
    }) style="display:inline-block;border:2px solid#000;background:${ // style
    '02579'.indexOf( i%12 - 1 ) < 0 ?                          // b or w
    '#fff;width:54;height:129;color:#000' :                    // white
    '#000;position:absolute;margin-left:-14;width:27;height:70'}">${ // black
        'I9O0P[=]    Q2W3ER5T6Y7UZSXDCVGBHNJM'[i]              // show key
    }</div>${++i%12 ? '' : '<br>'}`;                           // 12 keys per row

// init
E(  Z = [],  // canceled notes
    A = []); // active note array

// update to fade out canceled notes
setInterval(e=>Z.map((s,i)=>              // go through canceled notes
        (s.gain.gain.value -= .1) > 0 || // ramp off gain 
        (Z.splice(i,1), s.stop())),       // remove and stop if gain is 0
    9);                                   // 9 ms update

//////////////////////////////////////////////////////////////
// keyboard control

// get piano key from keyboard key
K = e=> e.key ?                                  // check for invalid key
    (k = 'ZSXDCVGBHNJM,L.;/Q2W3ER5T6Y7UI9O0P[=]' // map key to note
    .indexOf(e.key.toUpperCase()),               // find the key
    k > 16 ? k-5 : k) : -1;                      // remap second row of keys

// play note on key down
onkeydown = e=>
    document.activeElement == S | // not when editing seed
        e.repeat ? 0 :            // prevent key repeats
        P(K(e));                  // play note

// release note on key up
onkeyup = e=> X(K(e));

</script>