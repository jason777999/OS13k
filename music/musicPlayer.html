<style>body{background:#111;color:#fff;user-select:none;text-align:center;overflow-x:hidden;white-space:nowrap}</style>
<div id=N style=font-size:27;font-family:arial>&nbsp;</div>
<div id=F style=height:9></div><br>
<button onmousedown=P()>Play</button>
<button onmousedown=X&&X.stop(X=0)>Stop</button>
<button onmousedown=A()>Add</button>
<button onmousedown=R()>Remove</button><br><br>
Volume <input type=range id=V value=100>
Loop <input type=checkbox id=O><br>
<canvas id=C style=width:350;height:29;image-rendering:-moz-crisp-edges;image-rendering:pixelated></canvas><br>
<select id=S size=9 style=width:350;background:#000;color:#fff>
<script src=songs/cuddly.js></script>
<script src=songs/iamback.js></script>
<script src=songs/sanxion.js?1></script>
<script>

OS13k = parent.OS13k; // get OS13k
X =     // current playing sound
E =     // added song key
T = 0;  // current song time
Q = -1; // pending song to play

// update loop
U=k=>
{
    // play queued song
    Q < 0 || (                        // check if there is a queued song
        l = L[Q],                     // get song from list
        T = 0,                        // reset time
        Q = -1,                       // reset song to play
        (X = OS13k.PlayMusic(l.d)) || // play the music
            alert`⚠️ Error!`);         // song failed to play

    // copy analyzer canvas
    C.getContext`2d`.drawImage(OS13k.GetAnalyser(), 0, 0, C.width = 32, C.height = 32);

    // update song info
    F.innerText = X ? (                              // check if song playing
        X.gain.gain.value = V.value / 100,           // set music volume
        d = X.buffer.duration,                       // get buffer duration
        T += .05,                                    // update time
        X.loop = O.checked ?                         // set loop
            T %= d :                                 // wrap time if looping
            T > d && X.stop(X = 0),                  // stop song if ended
        W(T) + '/' + W(d))                           // display song time
        : (N.innerText = 'OS13k Music Player', '');  // reset name if not playing  
}

// build song list
B=k=>
{
    i = S.selectedIndex; // save selected index
    S.innerHTML = '';    // clear select html 
    Z = 0;               // track user song count
    L = [];              // clear song list

    for (k in localStorage) I(k);                  // search local storage for songs
    
    L.sort((i,j)=>i.n.localeCompare(j.n))          // sort songs
        .map(e=>                                   // add songs to select
        S.innerHTML += `<option>${e.n}</option>`); // create option

    S.selectedIndex =                              // set selected index back
        OS13k.Clamp(                               // clamp to select length
            E ? L.findIndex(e=>e.k == E) : i,      // look for added song key 
            E = 0, S.length - 1);                  // clamp to select length
            
    localStorage.OS13kM = JSON.stringify(K);       // save known song list
}

// insert song into list
I=k=> // key
{
    p = k.split`,`;                          // get key parts
    f = p.shift();                           // get first part of key
    if (f.substring(0,10) != 'OS13kMusic')   // check if music key
        return;
            
    n = p[0] ? p[0] : 'Untitled';            // get song name
    f.substring(10,11) == 'U' ?              // check if user song
        Z = Math.max(Z, f.substring(11)) :   // update highest user song
        K.indexOf(k) < 0 && (OS13k.Popup(    // check if new song
            '🎵 New Music<br><b>' + n, n),   // new music popup
            K.push(k));                      // add song to known list
              
    try {                                    // try to load the data
        (d = J(localStorage[k])) && (        // get song data
            L.push({d, k, n}));              // add to song list
    } catch(e) {console.log(e)}              // load failed
}

// play song
P=k=>
{
    X && X.stop(X = 0);          // stop song if playing
    Q = S.selectedIndex;         // set queued song index
    Q < 0 ||                     // check if no selection
        (N.innerText = L[Q].n,       // set queued song index
        F.innerText = 'Loading...'); // set loading message
}

// add custom song
A=k=>
{
    // test song [[[,0,219,,,,,1.1,,-.1,-50,-.05,-.01,1],[2,0,84,,,.1,,.7,,,,.5,,6.7,1,.05]],[[[1,1,0,0,0,0,1,5,32,0,0,0],[2,8,0,2,8,16,1,3,0,0,0,0]]],[0,0,0,0],4,[-1,1]]

    try {                                              // try to add song
        j = J( d = prompt `ZzFXM Data`                 // convert to json and back
            .replace(/(?![\[,])([^,\[\]]+)(?=[\],])/g, // look for numbers
                (i,j)=>j*1)                            // convert to float
      	     .replace(/([\[,])(?=[\],])/g, '$1null')); // insert nulls
             
        parent.zzfxM(...j);                            // try to generate song
        
        B(                                             // rebuild song list
            localStorage[                              // add song to storage
                E = `OS13kMusicU${ Z+1 },` +           // create user song key
                prompt`Name`.replace(/,/g, '')         // get song name
            ] = d);                                    // set data
    }
    catch (e) { alert`⚠️ Error!`; console.log(e);}      // load failed
}

// remove song
R=k=> confirm`Remove?` &&                             // confirm to remove
        B(localStorage[L[S.selectedIndex].k] = 0);    // remove and rebuild

// parse json and replace null with undefined
J=k=> JSON.parse(k, (i,j)=> j == null ? undefined : j)

// convert seconds to time string
W=k=> (k/60|0) + ((k = k%60|0) <=9 ? ':0' : ':') + k;

// test song
localStorage['OS13kMusic,OS13k Test Song'] = JSON.stringify(
[
    [                                        // Instruments
      [,0,219,,,,,1.1,,-.1,-50,-.05,-.01,1], // #1 - Snare
      [2,0,84,,,.1,,.7,,,,.5,,6.7,1,.05]     // #2 - Kick drum
    ],
    [                                        // Patterns
      [             // Pattern 0
        [           // Channel 0
          1, 1, 0,  // Using instrument 1, play C-1
          0, 0, 0,
          1, 5, 32, // Using instrument 1, play E-1 with 50% attenuation
          0, 0, 0
        ],
        [           // Channel 1
          2, 8, 0,  // Using instrument 2, play G-1
          2, 8, 16, // Using instrument 2, play G-1 with 25% attenuation
          1, 3, 0,  // Using instrument 3, play D-1
          0, 0, 0
        ]
      ]
    ],
    [0, 0, 0, 0],   // Sequence, Play pattern 0 four times
    4,              // Playback speed 4
    [-1, 1]         // Panning info. ch1=left ch2=right
]
); // test song

// load know songs
K = localStorage.OS13kM ? JSON.parse(localStorage.OS13kM) : []

// build music list and stop music when unloaded
B(onunload=_=> X && X.stop());

// set update interval
setInterval(U, 50);

</script>