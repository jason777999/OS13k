<style>body{background:#111;color:#fff;user-select:none;text-align:center;overflow-x:hidden}</style>
<div id=N style=font-size:27;font-family:monospace;white-space:nowrap>OS13k Music Player</div>
<div id=F style=font-family:monospace;height:9></div><br>
<button onmousedown=P()>Play</button>
<button onmousedown=X&&X.stop(X=0)>Stop</button>
<button onmousedown=R()>Remove</button>
<button onmousedown=A()>Add</button> &nbsp;
<span style=white-space:nowrap>Loop <input type=checkbox id=O></span><br>
<canvas id=C style=width:250;height:29></canvas>
<select id=S size=9 style=width:250;background:#000;color:#fff>
<script src=songs/cuddly.js></script>
<script src=songs/iamback.js></script>
<script src=songs/sanxion.js></script>
<script src=songs/error.js></script>
<script>

OS13k = parent.OS13k; // get OS13k
X =     // current playing sound
E =     // added song key
T = 0;  // current song time
Q = -1; // pending song to play

// update loop
U=k=>
{
    // play queued song
    Q < 0 || (                        // check if there is a queued song
        l = L[Q],                     // get song from list
        T = 0,                        // reset time
        Q = -1,                       // reset song to play
        (X = OS13k.PlayMusic(l.d)) || // play the music
            alert`⚠️ Error!`);           // song failed to load

    // copy analyzer canvas
    C.getContext`2d`.drawImage(OS13k.GetAnalyzer(), 0, 0, C.width = 32, C.height = 32);

    // update song info
    F.innerText = X ? (                              // check if song playing
        d = X.buffer.duration,                       // get buffer duration
        T += .05,                                    // update time
        X.loop = O.checked ?                         // set loop
            T %= d :                                 // wrap time if looping
            T > d && X.stop(X = 0),                  // stop song if ended
        V(T) + '/' + V(d))                           // display song time
        : (N.innerText = 'OS13k Music Player', '');  // reset name if not playing  
}

// build song list
B=k=>
{
    i = S.selectedIndex; // save selected index
    S.innerHTML = '';    // clear select input 
    Z = 0;               // track user song count
    L = [];              // clear song list

    for (k in localStorage) I(k);                  // search local storage for songs
    
    L.sort((i,j)=>i.n.localeCompare(j.n))          // sort songs
        .map(e=>                                   // add songs to select
        S.innerHTML += `<option>${e.n}</option>`); // create option

    S.selectedIndex =                              // set selected index back
        OS13k.Clamp(                               // clamp to select length
            E ? L.findIndex(e=>e.k == E) : i,      // look for added song key 
            E = 0, S.length - 1);                  // clamp to select length
}

// insert song into list
I=k=> // key
{
    p = k.split`,`;                                  // get key parts
    f = p.shift();                                   // get first part of key
    if (f.substring(0,10) != 'OS13kMusic') return;   // check if music key
      
    f.substring(10,11) == 'U' &&                     // check if user song
        (Z = Math.max(Z, f.substring(11)));          // update highest user song
      
    try {                                            // try to load the data
        (d = JSON.parse(localStorage[k])) && (       // get song data
            L.push({d, k,                            // add to song list
                n : p.length ? p[0] : 'Untitled'})); // get song name                  
    } catch(e) {}                                    // load failed
}

// play song
P=k=>
{
    X && X.stop(X = 0);         // stop song if playing
    N.innerText = L[            // set song name
        Q = S.selectedIndex].n; // set queued song index
    F.innerText = 'Loading...'; // set loading message
}

// add custom song
A=k=>
{
    // test song [[[,0,219,,,,,1.1,,-.1,-50,-.05,-.01,1],[2,0,84,,,.1,,.7,,,,.5,,6.7,1,.05]],[[[1,1,0,0,0,0,1,5,32,0,0,0],[2,8,0,2,8,16,1,3,0,0,0,0]]],[0,0,0,0],4,[-1,1]]

    try {                                              // try to add song
        j = JSON.parse( d = prompt `ZzFXM Song Data`   // convert song to json
            .replace(/(?![\[,])([^,\[\]]+)(?=[\],])/g, // look for numbers
                (e,i)=>parseFloat(i))                  // parse floats
      	     .replace(/([\[,])(?=[\],])/g,             // look for empty spaces
                (e,i)=>i+'null'));                     // insert null
             
        parent.zzfxM(...j);                            // try to generate song
        
        B(                                             // rebuild song list
            E = `OS13kMusicU${ Z+1 },` +               // create user song key
            prompt`Song Name`.replace(/,/g, ''),       // get song name
            localStorage[E] = d);                      // add song to storage
    }
    catch (e) { alert`⚠️ Error!`; }                     // load failed
}

// remove song
R=k=>(l = L[S.selectedIndex])                // get selected song
        .n.substring(0,5) == 'OS13k' ?       // check if system song
    alert`⚠️ Can not remove default songs!` : // error message
    confirm`Remove this song?` &&            // confrirm to remove
        B(localStorage[l.k] = X = 0);        // remove and rebuild

// convert seconds to time string
V=k=> (k/60|0) + ((k = k%60|0)<=9 ? ':0' : ':') + k;

// test song
localStorage['OS13kMusic,OS13k Test Song'] = JSON.stringify(
[
    [                                        // Instruments
      [,0,219,,,,,1.1,,-.1,-50,-.05,-.01,1], // #1 - Snare
      [2,0,84,,,.1,,.7,,,,.5,,6.7,1,.05]     // #2 - Kick drum
    ],
    [                                        // Patterns
      [             // Pattern 0
        [           // Channel 0
          1, 1, 0,  // Using instrument 1, play C-1
          0, 0, 0,
          1, 5, 32, // Using instrument 1, play E-1 with 50% attenuation
          0, 0, 0
        ],
        [           // Channel 1
          2, 8, 0,  // Using instrument 2, play G-1
          2, 8, 16, // Using instrument 2, play G-1 with 25% attenuation
          1, 3, 0,  // Using instrument 3, play D-1
          0, 0, 0
        ]
      ]
    ],
    [0, 0, 0, 0],   // Sequence, Play pattern 0 four times
    4,              // Playback speed 4
    [-1, 1]         // Panning info. ch1=left ch2=right
]
); // test song

// build music list and stop music when unloaded
B(onunload=_=> X && X.stop());

// set update interval
setInterval(U, 50);

</script>