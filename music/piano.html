<style>body{background:#111;color:#fff;user-select:none;text-align:center}</style><span id=B></span>Seed <input id=S style=width:79 oninput=E(T=3,localStorage.OS13kP=S.value) onfocus=E(T=3)>
Octave <input type=number id=O style=width:40 value=0 min=-3 max=3 onfocus=this.blur()>&nbsp;
Key <input type=number id=Y style=width:40 value=0 min=-12 max=12 onfocus=this.blur()><br>
Gain <input type=range style=width:60 id=V onchange=R() value=50>
Noise <input type=range style=width:60 id=N onchange=R() value=0>
Shape <input type=range style=width:60 id=H onchange=R() value=50>
Crush <input type=range style=width:60 id=C onchange=R() value=0><hr><div><script>

Z = []; // canceled notes
A = []; // played note array

//////////////////////////////////////////////////////////////
// sound

// build cached samples
R=e=> D =                         // save cached sound
    T-3 ? [                       // instruments
        [1, 2, 4, 8, 16],         // organ
        [3, 5, 7, 9, 11],         // oboe
        [1]                       // sin wave
    ][ T ].map(e=>                // get instrument
            parent.zzfxG(...[     // generate zzfx samples
            V.value/150/          // get volume
                (1+Math.log2(e)), // scale volume
            0,                    // no randomness
            e*440,,               // root frequency A 440
            5,,,                  // sustain
            (H.value/50)**4,,,,,, // shape curve
            N.value/99,,          // noise
            C.value/500,,         // bit crush
            .7,                   // sustain volume
            .1                    // decay
        ])) :
    [OS13k.SeedSamples(S.value, 1, V.value / 50, 0)]; // get seed samples

// play a note
P=e=> e < 0 ||
(
    X(e),                        // cancel old note

    // animate button color
    b = eval('B' + e),           // get the button
    b.B = b.style.background,    // save old background color
    b.style.transition = '',     // unset transition
    b.style.background = '#f00', // set background to red
    b.innerText,                 // force reset transition
    b.style.transition = '9s',   // set transition
    b.style.background = '#00f', // change to blue when held
    
    
    // play cached sound
    A[e] = D.map(d=>((s = OS13k.PlaySamples(d, 1))                   // play samples
        .detune.value = (e - 33 + O.value*12)*100 + Y.value*100, s)) // set frequency
);

// cancel a note
X=e=> A[e] && (                 // has a note playing
    b = eval('B' + e),          // get button
    b.style.transition = '.5s', // set transition
    b.style.background = b.B,   // reset old background color
    Z.push(...A[e]));           // add to canceled sounds list

//////////////////////////////////////////////////////////////
// init

// rebuild everything
E=e=> R(                    // rebild cache
        B.innerHTML = '',   // clear HTML

        // create buttons
        ['Organ', 'Oboe', 'Wave'].map((i,j)=>              // instruments
            B.innerHTML +=                                 // add to HTML
            `<button style='border:5px solid ${            // button and border
                T-j? "#111" : "#f00" }' onmousedown=E(T=${ // border color
                j })>${                                    // click
                i }</button> `),                           // text
                
        // set seed boder
        S.style.border = `5px solid ${                    // set border
            (C.disabled = H.disabled = N.disabled = T==3) // disable if seed
            ? "#f00" : "#111"}`);                         // set color

// create piano keys
for( T = i = 0;  // init selected sound & iterator
        i < 36;) // 36 keys
    document.body.innerHTML +=                                 // add to html
    `<div id=B${ z = 24 - (i/12|0)*12 + i%12                   // reorder keys
    } onmouseover=event.buttons&&P(${ z                        // mouse over
    }) onmousedown=P(${ z                                      // mouse down
    }) onmouseup=X(${ z                                        // mouse up
    }) onmouseout=X(${ z                                       // mouse out
    }) style="display:inline-block;border:1px solid #000;background:${ // style
    '02579'.indexOf( i%12 - 1 ) < 0 ?                          // b or w
    '#fff;width:54;height:129' :                               // white
    '#000;position:absolute;margin-left:-14;width:27;height:70'}"></div>${ // black
    ++i%12 ? '' : '<br>'}`;

// load saved seed and init
E(S.value = localStorage.OS13kP|0 || 0);

// update to fade out canceled notes
setInterval(e=>Z.map((s,i)=>               // go through canceled notes
        (s.gain.gain.value -= .05 ) > 0 || // ramp off gain 
        (Z.splice(i,1), s.stop())),        // stop note if gain is 0
    9);                                    // 9 ms update

// cancel all sounds if focus lost
onblur=e=>A.map((e,i)=>X(i));

// stop all sounds if unloaded
onunload= A.map(e=>e.map(e=>e.stop()));
        
//////////////////////////////////////////////////////////////
// keyboard control

// get piano key from keyboard key
K=e=> e ? (k = 'zsxdcvgbhnjm,l.;/q2w3er5t6y7ui9o0p[=]' // map key to note
    .indexOf(e.key.toLowerCase()),                     // find the key
    k > 16 ? k-5 : k) : -1;                            // remap second row of keys

// play note on key down
onkeydown=e=>
    document.activeElement == S ||                 // not when editing seed
        e.repeat ? 0 :                             // prevent key repeats
        Math.abs(i = e.keyCode - 39) - 1 ?         // check for up & down arrows
        P(K(e)) :                                  // play note
        O.value = OS13k.Clamp(O.value - i, -3, 3); // octave control

// release note on key up
onkeyup=e=> K(e) < 0 || X(K(e));

</script>