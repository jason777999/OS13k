<!--

todo
- glsl
- mini dwitter
- bar on bottom with open window icons
- right click menu
    - create icon
    - create folder
    - delete
    - arrange
- custom alerts
- fit icons to window
- desktop local storage persistance
- icons that can open web links

-->
<html>
<head>
<title>OS13k</title>
<meta charset=utf-8>
<style>
*
{
    font-family: arial;
}
body
{
    overflow: hidden;
    background: linear-gradient(#223, #322);
    background-attachment: fixed;
}
</style>
</head>
<body>
<template id=template_icon>
<style>
:host
{
    position: absolute;
    display: flex;
    align-items: center;
    flex-direction: column;
    user-select: none;
}
.iconImage
{
    width: 64px;
    height: 64px;
    font-size: 42px;
    background: linear-gradient(#fff, #999);
    color: #000;
    border-radius: 9px;
    box-shadow: 3px 3px 5px #000F;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
    pointer-events: none;
}
.iconName
{
    text-align: center;
    font-size: 18px;
    color: #FFF;
    text-shadow: 1px 1px 5px #000;
    position: absolute;
    top: 70px;
}
</style>
</template>
<template id=template_window>
<style>
:host
{
    position: absolute;
    user-select: none;
    background: #FFF;
    display: flex;
    flex-direction: column;
    border: 2px solid black;
    box-shadow: 5px 5px 5px #000F;
    vertical-align: text-top;
}
.titleBar
{
    font-size: 36px;
    background: #aac;
    color: #000;
}
.frame
{
    position: relative;
    width: 100%;
    height: 100%;
    border: none;
    overflow: hidden;
}
.folder
{
    position: relative;
    width: 100%;
    height: 100%;
    border: none;
    overflow: hidden;
    background: #222;
    user-select: none;
}
.resize
{
    font-size: 25px;
    color: #000;
    position: absolute;
    top: 0; right: 23;
}
.close
{
    font-size: 40px;
    color: #000;
    position: absolute;
    top: 0; right: 0;
}
</style>
<span id=resize class=resize>üóñ</span>
<span id=close class=close>√ó</span>
</template>
<script>

"use strict";

const desktopLayout = 
[
    {name:'Help', icon:'‚ùì', src:'help.html?1'},
    {name:'Games', icon:'üéÆ', folder:
        [
            {name:"Queen's Gambit", icon:'<span style=color:#f0f>‚ôõ</span>', src:'games/queensGambit.html', width:1290, height:720},
            {name:'Free Cell', icon:'‚ô†Ô∏è', src:'games/freeCell.html', width:800, height:1e3, hideWhenClosed:1},
            {name:'Digit Dilemma', icon:'<span style="font-family:monospace">‚òª</span>', src:'games/digitDilemma.html'},
            {name:'Hue Jumper', icon:'üå≤', src:'games/hueJumper.html', width:1290, height:720},
        ]
    },
    {name:'Utilities', icon:'üîß', folder:
        [
            {name:'Test', icon:'‚úåÔ∏è', src:'test.html?2', hideWhenClosed:1},
        ]
    },
    {name:'System', icon:'‚öôÔ∏è', folder:[]},
    {name:'Toys', icon:'ü§ñ', folder:[]},
    {name:'Test Folder', folder:
        [
            {name:'Mother Goose', icon:'ü¶¢', src:'stories.html'},
        ]
    },
    {name:'Test Folder2', folder:[]},
];

const iconGridSizeX = 99;
const iconGridSizeY = 130;
const InitDesktop=_=>
{
    let X = iconGridSizeX/4-iconGridSizeX;
    const AddIcon=p=>
    {
        p.x=X+=iconGridSizeX; p.y=iconGridSizeX/4; 
        const icon = new OS13kIcon(p); 
        document.body.appendChild(icon); 
        return icon;
    }
    
    for (const i of desktopLayout)
        AddIcon(i);
}

/////////////////////////////////////////////////////////////////////////////
// icon object

let topIconZ = 0;
let openPos = 99;

class OS13kIcon extends HTMLElement
{
	constructor({x=0, y=0, name, icon, src, width=500, height=500, hideWhenClosed, allowMultiple, folder})
    {
		super();
        	
		this.shadow = this.attachShadow({mode: 'open'});
        
        if (folder && !icon)
            icon = 'üìÅ';
            
        this.name = name;
        this.icon = icon;
        this.src = src;
        this.windowWidth = width;
        this.windowHeight = height;
        this.SetPos(x, y);
        this.hideWhenClosed = hideWhenClosed || folder;
        this.allowMultiple = allowMultiple;
        this.folder = folder;
        
        this.shadowRoot.innerHTML = template_icon.innerHTML;
        
        const spanIcon = document.createElement('span');
        spanIcon.className = 'iconImage';
        spanIcon.innerHTML = icon;
        this.shadowRoot.appendChild(spanIcon);
        
        const spanName = document.createElement('span');
        spanName.className = 'iconName';
        spanName.innerHTML = name;
        this.shadowRoot.appendChild(spanName);
    }
    
    SetPos(x, y)
    {
        this.style.left = x;
        this.style.top = y;
    }
    
    Open()
    {
        if (this.os13kWindow && !this.allowMultiple)
        {
            this.os13kWindow.style.display = '';
            this.os13kWindow.focus();
            return;
        }
        
        // stager open positions
        openPos += 50;
        if (openPos > 300)
            openPos = 50;
            
        this.os13kWindow = new OS13kWindow({x:openPos, y:openPos, icon:this});
        document.body.appendChild(this.os13kWindow);
    }
    
    MouseDown()
    {
        if (this.parentElement && this.parentElement.os13kWindow)
            this.parentElement.os13kWindow.focus();
            
        const rect = this.getBoundingClientRect();
        const moveIcon = new OS13kIcon({x:rect.left, y:rect.top, name:this.name, icon:this.icon});
        moveIcon.style.opacity = .5;
        moveIcon.realIcon = this;
        moveIcon.style.zIndex = ++topWindowZ;
        document.body.appendChild(moveIcon);
        return moveIcon;
    }
    
    MouseUp(e)
    {
        const rect = this.getBoundingClientRect();
        document.body.removeChild(this);
        
        let x = rect.left;
        let y = rect.top;
        
        const element = document.elementFromPoint(e.x, e.y);
        if (!element)
            return;
        else if (element.localName == 'os13k-window')
        {
            if (!element.os13kIcon.folder)
                return;
                
            // check for recursion
            const DetectRecursion=icon=>
            {        
                if (icon.os13kWindow == element)
                    return 1;
                    
                if (icon.os13kWindow && icon.os13kWindow.folder)
                    for( const c of icon.os13kWindow.folder.children)
                        if (DetectRecursion(c))
                            return 1;
            }
            
            if (DetectRecursion(this.realIcon))
            {
                alert('Recursive folder structure detected!');
                return;
            }
                
            const rect = element.folder.getBoundingClientRect();
            x -= rect.left;
            y -= rect.top;
            
            element.folder.appendChild(this.realIcon);
            element.focus();
        }
        else
        {
            document.body.appendChild(this.realIcon);
            document.body.focus();
            if (topWindow)
                topWindow.SetActive(0);
            topWindow = 0;
        }
        
        this.realIcon.SetPos(x, y);
        this.realIcon.style.zIndex = ++topIconZ;
    }
} // OS13kIcon

customElements.define('os13k-icon', OS13kIcon);

/////////////////////////////////////////////////////////////////////////////
// frame object

let topWindow;
let topWindowZ = 1e6;

class OS13kWindow extends HTMLElement
{
	constructor({x, y, icon})
    {
		super();
        	
        this.maximized = 0;
        this.os13kIcon = icon;
        this.SetPos(x, y);
        this.style.width = icon.windowWidth;
        this.style.height = icon.windowHeight;
        
		this.shadow = this.attachShadow({mode: 'open'});
        this.shadowRoot.innerHTML = template_window.innerHTML;
        
        // create title bar
        const spanTitleBar = document.createElement('span');
        spanTitleBar.className = 'titleBar';
        spanTitleBar.id = 'titleBar';
        spanTitleBar.innerHTML = '&nbsp;' + icon.icon + ' ' + icon.name;
        this.shadowRoot.appendChild(spanTitleBar);
        this.titleBar = spanTitleBar;
        
        if (icon.folder)
        {
            // create div frame
            const folder = document.createElement('div');
            this.folder = folder;
            folder.className = 'folder';
            folder.os13kWindow = this;
            this.shadow.appendChild(folder);
            this.focus();

            // add icons to folder
            let X = iconGridSizeX/4-iconGridSizeX;
            const AddIcon=p=>
            {
                p.x=X+=iconGridSizeX; p.y=iconGridSizeX/4; 
                folder.appendChild(new OS13kIcon(p));
            }
            for (const i of icon.folder)
                AddIcon(i);
        }
        else if (icon.src)
        {
            // create iframe
            const frame = document.createElement('iframe');
            this.frame = frame;
            frame.className = 'frame';
            frame.sandbox.add('allow-scripts');
            frame.sandbox.add('allow-same-origin');
            frame.sandbox.add('allow-popups');
            frame.sandbox.add('allow-pointer-lock');
            frame.onload=e=>
            {
                // init iframe
                const iframe_content = e.target.contentWindow;
                iframe_content.focus();
                
                try
                {
                    // todo: fix this on firefox, it works on chrome
                    iframe_content.zzfx = zzfx;
                    iframe_content.OS13k = OS13k;
                }
                catch 
                {
                    console.log('Error: could not pass OS13k globals to frame.');   
                };
                
            };
            //this.style.zIndex = ++topWindowZ;
            //frame.referrerPolicy = 'origin';
            //frame.referrerPolicy = 'same-origin';
            //frame.referrerPolicy = 'no-referrer';
            frame.src = icon.src;
            this.shadow.appendChild(frame);
        }
    }
    
    SetPos(x, y)
    {
        this.style.left = x;
        this.style.top = y;
    }
    
    focus()
    {
        super.focus();
        
        if (topWindow)
            topWindow.SetActive(0);
        topWindow = this;
        this.style.zIndex = ++topWindowZ;
        this.SetActive(1);
    }
    
    SetActive(active=1)
    {
        this.titleBar.style.background = active ? '#aac' : '#555';
    }
    
    Close()
    {
        if (this.os13kIcon.hideWhenClosed)
            this.style.display = 'none';
        else
        {
            this.remove();
            this.os13kIcon.os13kWindow = 0;
        }
    }
    
    MouseDown(id)
    {
        this.focus();
        if (id == 'close')
            this.Close();
        else if (id == 'resize')
            this.Resize();
        else if (id == 'titleBar' && this.frame)
            this.frame.style.pointerEvents = 'none';
            
        this.SetActive();
    }
    
    MouseUp()
    {
        if (this.frame)
            this.frame.style.pointerEvents = 'auto';
    }
    
    Resize()
    {
        this.maximized = !this.maximized;
        if (this.maximized)
        {
            this.oldLeft = this.style.left;
            this.oldTop = this.style.top;
            this.oldWidth = this.style.width;
            this.oldHeight = this.style.height;
            this.style.left = 0;
            this.style.top = 0;
            this.style.width = innerWidth-9;
            this.style.height = innerHeight-9;
        }
        else
        {
            this.style.left = this.oldLeft;
            this.style.top = this.oldTop;
            this.style.width = this.oldWidth;
            this.style.height = this.oldHeight;
        }
        
        this.shadowRoot.getElementById('resize').innerHTML = 
            this.maximized ? 'üóó' : 'üóñ';
    }
} // OS13kWindow

customElements.define('os13k-window', OS13kWindow);

////////////////////////////////////////fg/////////////////////////////////////
// input

let selected;
let seletOffsetX;
let seletOffsetY;
let lastMouseDownTarget;
let lastMouseDownTargetTime;

onmousedown=e=>
{
    if (selected)
    {
        // prevent getting stuck
        selected.MouseUp(e);
        selected = 0;
        return;
    }
    
    const originalTarget = e.originalTarget || e.path[0];
    let target = originalTarget.parentNode.host || originalTarget;
    
    const rect = target.getBoundingClientRect();
    seletOffsetX = e.x - rect.left;
    seletOffsetY = e.y - rect.top;
    
    if (target.localName == 'os13k-icon')
    {
        if (lastMouseDownTarget == target && lastMouseDownTargetTime > Date.now())
        {
            // handle double click
            target.Open();
            return;
        }
        
        lastMouseDownTarget = target;
        lastMouseDownTargetTime = Date.now() + 300;
        target = target.MouseDown();
    }
    else if (target.localName == 'os13k-window')
    { 
        target.MouseDown(originalTarget.id);
        
        // only allow dragging from the title bar
        if (originalTarget.id != 'titleBar')
            return;
    }
    else
        return;
        
    selected = target;
}

onmouseup=e=>
{
    if (selected)
        selected.MouseUp(e);
    selected = 0;
}

onmousemove=e=>
{
    if (selected)
        selected.SetPos(e.x - seletOffsetX, e.y - seletOffsetY);
}

/////////////////////////////////////////////////////////////////////////////
// ZzFXMicro - Zuper Zmall Zound Zynth 

let zzfxV = .3; // volume
const zzfx =      // play sound
(I=1,J=.05,g=220,f=0,h=0,m=.1,n=0,K=1,r=0,z=0,t=0,A=0,u=0,B=0,v=0,L=0,e=0,d=2*Math.PI,b=44100,w=p=>2*p*Math.random()-p,C=p=>0<p?1:-1,M=r*=500*d/b**2,D=g*=(1+w(J))*d/b,N=C(v)*d/4,q=[],E=0,F=0,c=0,k=1,G=0,H=0,a=0,O,l,x,y=zzfxX.createBufferSource())=>{f=99+f*b|0;h=h*b|0;m=m*b|0;e=e*b|0;z*=500*d/b**3;l=f+h+m+e;v*=d/b;t*=d/b;A*=b;for(u*=b;c<l;q[c++]=a)++H>100*L&&(H=0,a=E*g*Math.sin(F*v-N),a=n?1<n?2<n?3<n?Math.sin((a%d)**3):Math.max(Math.min(Math.tan(a),1),-1):1-(2*a/d%2+2)%2:1-4*Math.abs(Math.round(a/d)-a/d):Math.sin(a),a=C(a)*Math.abs(a)**K,a*=I*zzfxV*(c<f?c/f:c<f+h?1:c<l-e?1-(c-f-h)/m:0),a=e?a/2+(e>c?0:(c<l-e?1:(c-l)/e)*q[c-e]/2):a),E+=1+w(B),F+=1+w(B),g+=r+=z,k&&++k>A&&(D+=t,g+=t,k=0),u&&++G>u&&(g=D,r=M,G=1,k=k||1);x=zzfxX.createBuffer(1,q.length,b);x.getChannelData(0).set(q);y.buffer=x;y.connect(zzfxX.destination);y.start()};const zzfxX=new(window.AudioContext||webkitAudioContext);zzfxX.z=zzfxX.createBufferSource;zzfxX.createBufferSource=(s=zzfxX.z())=>(s.start=s.start||(t=>zzfxX.noteOn(t)),s)

/////////////////////////////////////////////////////////////////////////////
// OS13k
        
class _OS13k
{
    constructor()
    {
        this.lastActiveElement;
    }

    Alert(text)
    {
        alert(text);
    }
    
    Update()
    {
        const activeElement = document.activeElement;
        if (this.lastActiveElement != activeElement)
        {
            if (activeElement.localName == 'os13k-window')
                activeElement.focus();
            this.lastActiveElement = activeElement;
        }
    }
} // _OS13k

const OS13k = new _OS13k;
setInterval(OS13k.Update,100);
InitDesktop();

</script>
</body>
</html>